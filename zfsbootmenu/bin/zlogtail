#!/bin/bash
# vim: softtabstop=2 shiftwidth=2 expandtab

# shellcheck disable=SC1091
source /lib/zfsbootmenu-core.sh >/dev/null 2>&1 || exit 1
source /lib/zfsbootmenu-lib.sh >/dev/null 2>&1 || exit 1

log_tail() {
  [ -f "${BASE}/have_errors" ] && rm "${BASE}/have_errors"
  [ -f "${BASE}/have_warnings" ] && rm "${BASE}/have_warnings"

  [ -z "${FUZZYSEL}" ] && FUZZYSEL=fzf

  HEIGHT="$( tput lines )"

  fuzzy_default_options+=(
    "--no-sort" "--ansi" "--tac" "--no-mouse"
    "--inline-info" "--height $(( HEIGHT - 1 ))"
  )

  if [ -n "${HAS_DISABLED}" ]; then
    fuzzy_default_options+=(
      "--disabled"
    )
  fi

  export FZF_DEFAULT_OPTS="${fuzzy_default_options[*]}"

  source /lib/zfsbootmenu-core.sh >/dev/null 2>&1 || exit 1
  source /lib/zfsbootmenu-lib.sh >/dev/null 2>&1 || exit 1
  draw_page

  # Try to use feature flags found on dmesg from util-linux
  if output="$( dmesg --notime -f user -l err,warn 2>/dev/null )" ; then
    echo "${output}" | ${FUZZYSEL}
  else
    # fall back to manually parsing dmesg output; will show all ZBM generated logs up to zinfo level
    dmesg | awk '/ZFSBootMenu:/{ for (i=3; i<=NF; i++){ printf("%s ", $i)}; printf "\n" }' | ${FUZZYSEL}
  fi
}

log_tail
tput clear
